{% from "jenkins/map.jinja" import jenkins with context %}

upstream app_server {
    server 127.0.0.1:{{ jenkins.jenkins_port }} fail_timeout=0;
}

server {
    listen {{ jenkins.port }};

    {% if jenkins.server_name %}
    server_name {{ jenkins.server_name }};
    {% endif %}

    location / {

      proxy_set_header        Host $host;
      proxy_set_header        X-Real-IP $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;

      proxy_read_timeout 90;
      {% if jenkins.server_name %}
      proxy_redirect    http://127.0.0.1:{{ jenkins.jenkins_port }} $scheme://{{ jenkins.server_name }};
      {% else %}
      proxy_redirect    off;
      {% endif %}

      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;

        if (!-f $request_filename) {
            proxy_pass http://app_server;
            break;
        }
    }
}
